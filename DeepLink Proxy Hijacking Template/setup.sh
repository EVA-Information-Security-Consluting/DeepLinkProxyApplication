#!/bin/bash

# Deep Link Proxy - Quick Setup Script
# This script helps configure the proxy for a target app

set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ”— Deep Link Proxy - Quick Setup"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

CONFIG_FILE="app/src/main/res/values/config.xml"

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ Error: Config file not found at $CONFIG_FILE"
    exit 1
fi

echo "This script will help you configure the proxy."
echo ""

# Get server URL
echo "ğŸ“¡ Step 1: Server Configuration"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Enter your Burp Collaborator or webhook URL:"
echo "Examples:"
echo "  - https://abc123.oastify.com"
echo "  - https://webhook.site/unique-id"
echo "  - https://requestbin.com/your-bin"
echo ""
read -p "Server URL: " SERVER_URL

if [ -z "$SERVER_URL" ]; then
    echo "âŒ Server URL cannot be empty!"
    exit 1
fi

# Get target package
echo ""
echo "ğŸ“± Step 2: Target App Configuration"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Enter the target app's package name:"
echo ""
echo "ğŸ’¡ Tip: Find it with: adb shell pm list packages | grep KEYWORD"
echo ""
read -p "Target Package: " TARGET_PACKAGE

if [ -z "$TARGET_PACKAGE" ]; then
    echo "âŒ Target package cannot be empty!"
    exit 1
fi

# Get deep link scheme
echo ""
echo "ğŸ”— Step 3: Deep Link Scheme"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Enter the deep link scheme to intercept:"
echo "Examples: instagram, spotify, myapp, etc."
echo ""
read -p "Scheme: " DEEP_LINK_SCHEME

if [ -z "$DEEP_LINK_SCHEME" ]; then
    echo "âŒ Scheme cannot be empty!"
    exit 1
fi

# Optional settings
echo ""
echo "âš™ï¸  Step 4: Optional Settings (press Enter for defaults)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

read -p "Forward delay in milliseconds [1000]: " FORWARD_DELAY
FORWARD_DELAY=${FORWARD_DELAY:-1000}

read -p "Enable local logging? (true/false) [true]: " ENABLE_LOGGING
ENABLE_LOGGING=${ENABLE_LOGGING:-true}

read -p "Show debug toasts? (true/false) [false]: " SHOW_TOASTS
SHOW_TOASTS=${SHOW_TOASTS:-false}

# Update config.xml
echo ""
echo "ğŸ“ Updating configuration..."

cat > "$CONFIG_FILE" <<EOF
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <!-- 
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Deep Link Proxy Configuration
    Generated by setup.sh on $(date)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    
    <!-- Server URL for data exfiltration -->
    <string name="server_url">$SERVER_URL</string>
    
    <!-- Target app package name -->
    <string name="target_package">$TARGET_PACKAGE</string>
    
    <!-- Deep link scheme to intercept -->
    <string name="deep_link_scheme">$DEEP_LINK_SCHEME</string>
    
    <!-- Optional Settings -->
    <integer name="forward_delay_ms">$FORWARD_DELAY</integer>
    <bool name="enable_local_logging">$ENABLE_LOGGING</bool>
    <bool name="show_debug_toasts">$SHOW_TOASTS</bool>
</resources>
EOF

echo "âœ… Configuration updated!"
echo ""

# Summary
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“‹ Configuration Summary"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Server URL:       $SERVER_URL"
echo "Target Package:   $TARGET_PACKAGE"
echo "Scheme:           $DEEP_LINK_SCHEME"
echo "Forward Delay:    ${FORWARD_DELAY}ms"
echo "Local Logging:    $ENABLE_LOGGING"
echo "Debug Toasts:     $SHOW_TOASTS"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Ask if user wants to build
read -p "ğŸ”¨ Build and install now? (y/n): " BUILD_NOW

if [ "$BUILD_NOW" = "y" ] || [ "$BUILD_NOW" = "Y" ]; then
    echo ""
    echo "ğŸ”¨ Building APK..."
    ./gradlew assembleDebug
    
    echo ""
    echo "ğŸ“± Installing to device..."
    adb install -r app/build/outputs/apk/debug/app-debug.apk
    
    echo ""
    echo "âœ… Installation complete!"
    echo ""
    echo "ğŸ¯ Test with:"
    echo "   adb shell am start -a android.intent.action.VIEW -d \"$DEEP_LINK_SCHEME://test\""
else
    echo ""
    echo "To build and install manually:"
    echo "  ./gradlew assembleDebug"
    echo "  adb install -r app/build/outputs/apk/debug/app-debug.apk"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… Setup Complete!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“š Next steps:"
echo "  1. Test deep link: ./test_deeplink.sh $DEEP_LINK_SCHEME://test"
echo "  2. Monitor logs: ./monitor_tokens.sh"
echo "  3. Extract data: ./extract_logs.sh"
echo ""
echo "ğŸ“– For more info, see README.md and CONFIG.md"
echo ""

